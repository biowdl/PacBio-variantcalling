- name: test-workflow
  tags:
    - integration
  command: >
    cromwell run
    --options tests/data/config/cromwell.options.json
    --inputs tests/data/config/variant_calling.json
    PacBio-variantcalling.wdl
  stdout:
    contains_regex:
      - 'SubreadsProcessing.limaReads.*batch.1.march.Sample_1_3p--Sample_1_3p.bam'
      - 'Starting VariantCalling.index'
    contains:
      - 'Starting VariantCalling.index'
      - '--num-threads 8'
  files:
    - path: test-output/Sample_1_3p.g.vcf.gz
    - path: test-output/Sample_1_3p.g.vcf.gz.tbi
    - path: test-output/Sample_1_3p.phased.vcf.gz.tbi
    - path: test-output/Sample_1_3p.haplotagged.bam
    - path: test-output/Sample_1_3p.haplotagged.bam.bai
    - path: test-output/Sample_1_3p.phased.blocklist
    - path: test-output/Sample_1_3p.phased.gtf
    - path: test-output/Sample_1_3p.phased.tsv
    - path: test-output/Sample_1_3p.phased.vcf.gz
      contains:
        - "#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO\tFORMAT\tSample_1_3p"

    - path: test-output/Sample_3_3p.phased.vcf.gz
      contains:
        - "#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO\tFORMAT\tSample_3_3p"

    - path: test-output/Sample_4_3p.phased.vcf.gz
      contains:
        - "#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO\tFORMAT\tSample_4_3p"
    - path: test-output/multiqc/multiqc_report.html
      contains:
        - "Alignment Summary"
        - "GC Coverage Bias"
        - "Aligned Reads"
        - "Aligned Bases"
        - "Mean Read Length"
        - "ZMWs filtered and passed"
        - "Counts"
        - "MeanScore"
        - "ZMWs filtered by Lima"
        - "block_n50"
        - "variant_per_block_avg"
        - "Phasing per Sample"
        - "Phasing per Gene"
        - "PGx"
        - "Minor_capsid_protein"
        - "Large_T_antigen"
      must_not_contain:
        - "Sample_1_3p--Sample_1_3p"
        - "Sample_3_3p--Sample_3_3p"
        - "Sample_4_3p--Sample_4_3p"

- name: test-workflow-mmi
  tags:
    - integration
  command: >
    cromwell run
    --options tests/data/config/cromwell.options.json
    --inputs tests/data/config/variant_calling_mmi_index.json
    PacBio-variantcalling.wdl
  stdout:
    must_not_contain:
      - 'Starting VariantCalling.index'
      - '/opt/deepvariant/bin/run_deepvariant'
  files:
    - path: test-output/Sample_4_3p.g.vcf.gz
    - path: test-output/Sample_4_3p.phased.vcf.gz
    - path: test-output/Sample_4_3p.phased.gtf
    - path: test-output/Sample_4_3p.phased.tsv
    - path: test-output/Sample_4_3p.phased.blocklist
    - path: test-output/multiqc/multiqc_report.html
      contains:
        - "Sample_1_3p--Sample_1_3p"
        - "Sample_3_3p--Sample_3_3p"
        - "Sample_4_3p--Sample_4_3p"
        - "block_n50"
        - "variant_per_block_avg"
      must_not_contain:
        - "Phasing per sample"
        - "Phasing per Gene"
        - "PGx"
        - "Minor_capsid_protein"
        - "Large_T_antigen"

- name: test-workflow-DeepVariant
  tags:
    - integration
  command: >
    cromwell run
    --options tests/data/config/cromwell.options.json
    --inputs tests/data/config/variant_calling_DeepVariant.json
    PacBio-variantcalling.wdl
  stdout:
    must_not_contain:
      - 'Starting VariantCalling.index'
      - 'HaplotypeCaller'
    contains:
      - '/opt/deepvariant/bin/run_deepvariant'

  files:
    - path: test-output/Sample_4_3p.g.vcf.gz
    - path: test-output/Sample_4_3p.g.vcf.gz.tbi
    - path: test-output/Sample_4_3p.phased.vcf.gz
    - path: test-output/Sample_4_3p.phased.vcf.gz.tbi
    - path: test-output/Sample_4_3p.haplotagged.bam
    - path: test-output/Sample_4_3p.haplotagged.bam.bai
    - path: test-output/Sample_4_3p.phased.gtf
    - path: test-output/Sample_4_3p.phased.tsv
    - path: test-output/Sample_4_3p.phased.blocklist

- name: test-workflow-dbsnp
  tags:
    - integration
  command: >
    cromwell run
    --options tests/data/config/cromwell.options.json
    --inputs tests/data/config/variant_calling_dbsnp.json
    PacBio-variantcalling.wdl

- name: test-workflow-hsmetric
  tags:
    - integration
  command: >
    cromwell run
    --options tests/data/config/cromwell.options.json
    --inputs tests/data/config/variant_calling_hsmetric.json
    PacBio-variantcalling.wdl
  stdout:
    contains_regex:
      - 'BAIT_INTERVALS=.*LC029411.targets.interval'
      - 'TARGET_INTERVALS=.*LC029411.targets.interval'
  files:
    - path: test-output/multiqc/multiqc_report.html
      contains:
        - "Alignment Summary"
        - "GC Coverage Bias"
        - "HSMetrics"
        - "Target Region Coverage"

- name: test-workflow-hsmetric-baits
  tags:
    - integration
  command: >
    cromwell run
    --options tests/data/config/cromwell.options.json
    --inputs tests/data/config/variant_calling_hsmetric_baits.json
    PacBio-variantcalling.wdl
  stdout:
    contains_regex:
      - 'BAIT_INTERVALS=.*LC029411.baits.interval'
      - 'TARGET_INTERVALS=.*LC029411.targets.interval'
    must_not_contain_regex:
      - 'BAIT_INTERVALS=.*LC029411.targets.interval'
  files:
    - path: test-output/multiqc/multiqc_report.html
      contains:
        - "Alignment Summary"
        - "GC Coverage Bias"
        - "HSMetrics"
        - "Target Region Coverage"
    - path: test-output/multiqc/multiqc_data.zip
